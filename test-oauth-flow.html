<!DOCTYPE html>
<html>
<head>
    <title>OAuth Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .results { background: #f9f9f9; padding: 10px; margin: 5px 0; border-radius: 3px; font-family: monospace; font-size: 12px; }
        .error { background: #ffebee; color: #c62828; border-left: 4px solid #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; border-left: 4px solid #2e7d32; }
        .warning { background: #fff3e0; color: #f57c00; border-left: 4px solid #f57c00; }
        .info { background: #e3f2fd; color: #1976d2; border-left: 4px solid #1976d2; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-primary { background: #1976d2; color: white; }
        .btn-success { background: #2e7d32; color: white; }
        .btn-danger { background: #d32f2f; color: white; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>OAuth Flow End-to-End Test</h1>
        
        <div class="test-section">
            <h3>Server Status Check</h3>
            <button class="btn-primary" onclick="checkServers()">Check Server Status</button>
            <div id="server-status"></div>
        </div>

        <div class="test-section">
            <h3>OAuth Flow Test</h3>
            <p>This will test the complete OAuth flow including backend API calls.</p>
            <button class="btn-success" onclick="testOAuthFlow()">Start OAuth Flow Test</button>
            <button class="btn-danger" onclick="clearResults()">Clear Results</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `results ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            resultsDiv.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('server-status').innerHTML = '';
        }

        async function checkServers() {
            const statusDiv = document.getElementById('server-status');
            statusDiv.innerHTML = '<div class="status info">Checking servers...</div>';
            
            log('=== Server Status Check ===', 'info');
            
            // Check frontend server
            try {
                const frontendResponse = await fetch('http://localhost:4028/');
                const frontendStatus = frontendResponse.ok ? 'Running' : 'Error';
                log(`Frontend Server (4028): ${frontendStatus}`, frontendResponse.ok ? 'success' : 'error');
            } catch (error) {
                log(`Frontend Server (4028): Not accessible - ${error.message}`, 'error');
            }

            // Check backend server
            try {
                const backendResponse = await fetch('http://localhost:3001/health');
                const backendStatus = backendResponse.ok ? 'Running' : 'Error';
                log(`Backend Server (3001): ${backendStatus}`, backendResponse.ok ? 'success' : 'error');
                
                if (backendResponse.ok) {
                    statusDiv.innerHTML = '<div class="status success">✅ Both servers are running</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status warning">⚠️ Backend server has issues</div>';
                }
            } catch (error) {
                log(`Backend Server (3001): Not accessible - ${error.message}`, 'error');
                statusDiv.innerHTML = '<div class="status error">❌ Backend server is not running</div>';
            }
        }

        async function testOAuthFlow() {
            clearResults();
            log('=== OAuth Flow Test Started ===', 'info');
            
            // Step 1: Check if BungieAuthService is available
            log('Step 1: Checking BungieAuthService availability...', 'info');
            
            try {
                // Try to access the service from the main app
                const mainWindow = window.parent || window.opener || window;
                
                // Check if we can access the service
                const testFetch = await fetch('http://localhost:3001/health');
                if (testFetch.ok) {
                    log('✅ Backend server is accessible', 'success');
                } else {
                    log('❌ Backend server returned error', 'error');
                    return;
                }
                
                // Step 2: Test OAuth initiation
                log('Step 2: Testing OAuth initiation...', 'info');
                
                // Generate state like the real service does
                const state = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                log(`Generated OAuth state: ${state}`);
                
                // Store state in all storage mechanisms
                localStorage.setItem('bungie_oauth_state', state);
                sessionStorage.setItem('bungie_oauth_state', state);
                document.cookie = `bungie_oauth_state=${state}; max-age=600; path=/; SameSite=Lax`;
                
                log('✅ OAuth state stored in localStorage, sessionStorage, and cookies', 'success');
                
                // Step 3: Simulate OAuth callback
                log('Step 3: Simulating OAuth callback...', 'info');
                
                // Create a test callback URL
                const callbackUrl = `http://localhost:4028/auth/callback?code=test_auth_code_12345&state=${state}`;
                log(`Callback URL: ${callbackUrl}`);
                
                // Test URL parameter parsing
                const url = new URL(callbackUrl);
                const code = url.searchParams.get('code');
                const receivedState = url.searchParams.get('state');
                
                log(`Parsed - Code: '${code}', State: '${receivedState}'`);
                
                // Step 4: Test state validation
                log('Step 4: Testing state validation...', 'info');
                
                const storedLocal = localStorage.getItem('bungie_oauth_state');
                const storedSession = sessionStorage.getItem('bungie_oauth_state');
                const storedCookie = getCookie('bungie_oauth_state');
                
                log(`Stored states - Local: '${storedLocal}', Session: '${storedSession}', Cookie: '${storedCookie}'`);
                
                const isValid = receivedState === storedLocal || receivedState === storedSession || receivedState === storedCookie;
                
                if (isValid) {
                    log('✅ State validation passed', 'success');
                } else {
                    log('❌ State validation failed', 'error');
                    return;
                }
                
                // Step 5: Test backend API call
                log('Step 5: Testing backend API call...', 'info');
                
                try {
                    const apiResponse = await fetch('http://localhost:3001/bungie/oauth/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            grant_type: 'authorization_code',
                            code: code
                        })
                    });
                    
                    log(`API Response Status: ${apiResponse.status}`);
                    
                    if (apiResponse.ok) {
                        const responseData = await apiResponse.json();
                        log('✅ Backend API call successful', 'success');
                        log(`Response: ${JSON.stringify(responseData, null, 2)}`);
                    } else {
                        const errorText = await apiResponse.text();
                        log(`❌ Backend API call failed: ${errorText}`, 'error');
                    }
                } catch (apiError) {
                    log(`❌ Backend API call error: ${apiError.message}`, 'error');
                }
                
                log('=== OAuth Flow Test Completed ===', 'info');
                
            } catch (error) {
                log(`❌ OAuth flow test error: ${error.message}`, 'error');
            }
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Auto-check servers on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('Page loaded - Ready for testing', 'info');
                checkServers();
            }, 500);
        });
    </script>
</body>
</html>